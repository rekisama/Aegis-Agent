#!/usr/bin/env python3
"""
åŠ¨æ€å·¥å…·åˆ›å»ºç³»ç»Ÿæ¼”ç¤º
æ¼”ç¤ºAgentå¦‚ä½•è‡ªåŠ¨åˆ›å»ºå’Œä½¿ç”¨æ–°å·¥å…·
"""

import asyncio
import json
import logging
from pathlib import Path

# è®¾ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
import sys
project_root = Path(__file__).parent.parent
if str(project_root) not in sys.path:
    sys.path.insert(0, str(project_root))

from python.agent.core import Agent
from python.utils.config import load_config

async def demo_agent_creating_tools():
    """æ¼”ç¤ºAgentåˆ›å»ºæ–°å·¥å…·"""
    
    print("=== AgentåŠ¨æ€å·¥å…·åˆ›å»ºæ¼”ç¤º ===\n")
    
    # åˆå§‹åŒ–Agent
    config = load_config()
    agent = Agent(config)
    
    print("1. åˆå§‹åŒ–Agentå®Œæˆ")
    print(f"   å¯ç”¨å·¥å…·æ•°é‡: {len(agent.tools)}")
    print(f"   å·¥å…·åˆ—è¡¨: {list(agent.tools.keys())}\n")
    
    # ç¤ºä¾‹1ï¼šAgentè‡ªåŠ¨æ£€æµ‹éœ€è¦åˆ›å»ºå·¥å…·
    print("2. æµ‹è¯•è‡ªåŠ¨å·¥å…·åˆ›å»º")
    task1 = "å¸®æˆ‘åˆ›å»ºä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—çš„ç¬¬né¡¹"
    print(f"   ä»»åŠ¡: {task1}")
    
    result1 = await agent.execute_task(task1)
    print(f"   ç»“æœ: {json.dumps(result1, ensure_ascii=False, indent=2)}\n")
    
    # ç¤ºä¾‹2ï¼šæ‰‹åŠ¨åˆ›å»ºå·¥å…·
    print("3. æ‰‹åŠ¨åˆ›å»ºå·¥å…·")
    tool_spec = {
        "name": "string_processor",
        "description": "å­—ç¬¦ä¸²å¤„ç†å·¥å…·ï¼Œæ”¯æŒåè½¬ã€å¤§å†™ã€å°å†™ç­‰æ“ä½œ",
        "code": """
def process_string(text, operation):
    if not isinstance(text, str):
        raise ValueError("è¾“å…¥å¿…é¡»æ˜¯å­—ç¬¦ä¸²")
    
    if operation == "reverse":
        return text[::-1]
    elif operation == "upper":
        return text.upper()
    elif operation == "lower":
        return text.lower()
    elif operation == "title":
        return text.title()
    elif operation == "length":
        return len(text)
    else:
        raise ValueError(f"ä¸æ”¯æŒçš„æ“ä½œ: {operation}")

result = process_string(text, operation)
""",
        "parameters": {
            "text": "è¦å¤„ç†çš„å­—ç¬¦ä¸²",
            "operation": "æ“ä½œç±»å‹ (reverse/upper/lower/title/length)"
        }
    }
    
    print("   åˆ›å»ºå·¥å…·è§„èŒƒ...")
    creation_result = await agent.create_new_tool(tool_spec)
    print(f"   åˆ›å»ºç»“æœ: {json.dumps(creation_result, ensure_ascii=False, indent=2)}\n")
    
    # ç¤ºä¾‹3ï¼šä½¿ç”¨æ–°åˆ›å»ºçš„å·¥å…·
    if creation_result["success"]:
        print("4. ä½¿ç”¨æ–°åˆ›å»ºçš„å·¥å…·")
        task2 = "ä½¿ç”¨string_processorå·¥å…·å°†'Hello World'è½¬æ¢ä¸ºå¤§å†™"
        print(f"   ä»»åŠ¡: {task2}")
        result2 = await agent.execute_task(task2)
        print(f"   ç»“æœ: {json.dumps(result2, ensure_ascii=False, indent=2)}\n")
    
    # ç¤ºä¾‹4ï¼šæŸ¥çœ‹å·¥å…·ç»Ÿè®¡
    print("5. æŸ¥çœ‹å·¥å…·ç»Ÿè®¡")
    stats = agent.dynamic_tool_creator.get_tool_statistics()
    print(f"   ç»Ÿè®¡ä¿¡æ¯: {json.dumps(stats, ensure_ascii=False, indent=2)}\n")
    
    # ç¤ºä¾‹5ï¼šæµ‹è¯•å·¥å…·éªŒè¯
    print("6. æµ‹è¯•å·¥å…·éªŒè¯")
    invalid_tool_spec = {
        "name": "dangerous_tool",
        "description": "å±é™©å·¥å…·",
        "code": """
import os
import subprocess

def dangerous_operation():
    os.system("rm -rf /")  # å±é™©æ“ä½œ
    return "dangerous"

result = dangerous_operation()
""",
        "parameters": {}
    }
    
    print("   æµ‹è¯•å±é™©å·¥å…·åˆ›å»º...")
    validation_result = await agent._validate_tool_spec_with_llm(invalid_tool_spec)
    if validation_result is None:
        print("   âœ… å±é™©å·¥å…·è¢«æ­£ç¡®æ‹¦æˆª")
    else:
        print("   âŒ å±é™©å·¥å…·æœªè¢«æ‹¦æˆª")
    print()

async def demo_web_interface():
    """æ¼”ç¤ºWebç•Œé¢åŠŸèƒ½"""
    print("=== Webç•Œé¢åŠŸèƒ½æ¼”ç¤º ===\n")
    
    print("1. å¯åŠ¨WebæœåŠ¡å™¨")
    print("   è¿è¡Œ: python web/start_server.py")
    print("   è®¿é—®: http://localhost:8000")
    print()
    
    print("2. å·¥å…·ç®¡ç†åŠŸèƒ½")
    print("   - ç‚¹å‡»ä¾§è¾¹æ çš„'å·¥å…·ç®¡ç†'æŒ‰é’®")
    print("   - åˆ›å»ºæ–°å·¥å…·")
    print("   - æŸ¥çœ‹å·¥å…·åˆ—è¡¨")
    print("   - æµ‹è¯•å’Œåˆ é™¤å·¥å…·")
    print()
    
    print("3. APIç«¯ç‚¹")
    print("   - POST /api/tools/create - åˆ›å»ºå·¥å…·")
    print("   - GET /api/tools/dynamic - è·å–å·¥å…·åˆ—è¡¨")
    print("   - DELETE /api/tools/dynamic/{name} - åˆ é™¤å·¥å…·")
    print("   - POST /api/tools/dynamic/{name}/test - æµ‹è¯•å·¥å…·")
    print()

async def demo_file_monitoring():
    """æ¼”ç¤ºæ–‡ä»¶ç›‘æ§åŠŸèƒ½"""
    print("=== æ–‡ä»¶ç›‘æ§åŠŸèƒ½æ¼”ç¤º ===\n")
    
    print("1. å®æ—¶æ–‡ä»¶ç›‘æ§")
    print("   - ç›‘æ§ python/tools/dynamic/ ç›®å½•")
    print("   - è‡ªåŠ¨æ£€æµ‹æ–°å·¥å…·æ–‡ä»¶")
    print("   - çƒ­åŠ è½½å·¥å…·æ›´æ–°")
    print()
    
    print("2. æ‰‹åŠ¨åˆ›å»ºå·¥å…·æ–‡ä»¶ç¤ºä¾‹")
    example_tool = '''
"""
Dynamic Tool: calculator
Auto-generated by Agent
"""

import json
import logging
from typing import Dict, Any
from python.tools.base import BaseTool, ToolResult

class DynamicCalculatorTool(BaseTool):
    """Dynamic tool: calculator"""
    
    def __init__(self):
        super().__init__()
        self.name = "calculator"
        self.description = "Dynamic tool created by agent"
    
    async def execute(self, **kwargs) -> ToolResult:
        """Execute the dynamic tool"""
        try:
            # å‚æ•°éªŒè¯
            a = kwargs.get('a', 0)
            b = kwargs.get('b', 0)
            operation = kwargs.get('operation', 'add')
            
            # æ‰§è¡Œè®¡ç®—
            if operation == 'add':
                result = a + b
            elif operation == 'subtract':
                result = a - b
            elif operation == 'multiply':
                result = a * b
            elif operation == 'divide':
                result = a / b if b != 0 else 'Error: Division by zero'
            else:
                result = f'Error: Unknown operation {operation}'
            
            return ToolResult(
                success=True,
                data={"result": result},
                error=None
            )
            
        except Exception as e:
            return ToolResult(
                success=False,
                data={},
                error=str(e)
            )
'''
    
    tool_file = Path("python/tools/dynamic/dynamic_calculator.py")
    tool_file.write_text(example_tool, encoding='utf-8')
    print(f"   åˆ›å»ºç¤ºä¾‹å·¥å…·æ–‡ä»¶: {tool_file}")
    print("   æ–‡ä»¶ç›‘æ§å°†è‡ªåŠ¨æ£€æµ‹å¹¶åŠ è½½æ­¤å·¥å…·")
    print()

async def main():
    """ä¸»æ¼”ç¤ºå‡½æ•°"""
    print("ğŸš€ å¼€å§‹åŠ¨æ€å·¥å…·åˆ›å»ºç³»ç»Ÿæ¼”ç¤º\n")
    
    try:
        # æ¼”ç¤ºAgentæ ¸å¿ƒåŠŸèƒ½
        await demo_agent_creating_tools()
        
        # æ¼”ç¤ºWebç•Œé¢
        await demo_web_interface()
        
        # æ¼”ç¤ºæ–‡ä»¶ç›‘æ§
        await demo_file_monitoring()
        
        print("âœ… æ¼”ç¤ºå®Œæˆï¼")
        print("\nğŸ“ æ€»ç»“:")
        print("   - Agentèƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹ä»»åŠ¡éœ€æ±‚å¹¶åˆ›å»ºæ–°å·¥å…·")
        print("   - å·¥å…·åˆ›å»ºè¿‡ç¨‹åŒ…å«å®‰å…¨éªŒè¯")
        print("   - Webç•Œé¢æä¾›å®Œæ•´çš„å·¥å…·ç®¡ç†åŠŸèƒ½")
        print("   - æ–‡ä»¶ç³»ç»Ÿç›‘æ§æ”¯æŒå®æ—¶å·¥å…·å‘ç°")
        print("   - ç³»ç»Ÿå…·å¤‡å®Œæ•´çš„è‡ªæˆ‘è¿›åŒ–èƒ½åŠ›")
        
    except Exception as e:
        print(f"âŒ æ¼”ç¤ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
        logging.error(f"æ¼”ç¤ºå¤±è´¥: {e}")

if __name__ == "__main__":
    asyncio.run(main()) 